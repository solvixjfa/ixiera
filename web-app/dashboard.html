<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Dashboard Klien | Ixiera</title>
  
  <!-- Favicons & CSS -->
  <link href="https://ik.imagekit.io/solviXone/ixiera/img/pages/favicon.png" rel="icon">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/main.css" rel="stylesheet">
  <link href="assets/css/custom.css" rel="stylesheet">
  
  <style>
    :root {
      --rich-black: #0A0A0A;
      --deep-black: #000000;
      --charcoal: #1A1A1A;
      --dark-gray: #2A2A2A;
      --premium-gold: #D4AF37;
      --electric-blue: #0066CC;
      --neon-green: #00FF88;
      --pure-white: #FFFFFF;
    }
    
    body {
      background: var(--rich-black);
      min-height: 100vh;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--pure-white);
    }
    
    .premium-card {
      background: linear-gradient(145deg, var(--charcoal), var(--deep-black));
      border: 1px solid rgba(212, 175, 55, 0.1);
      border-radius: 20px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(212, 175, 55, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .premium-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--premium-gold), var(--electric-blue));
    }
    
    .stat-card {
      padding: 25px 20px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
    }
    
    .stat-card i {
      font-size: 2.2rem;
      margin-bottom: 15px;
      background: linear-gradient(135deg, var(--premium-gold), var(--electric-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .project-card {
      background: linear-gradient(145deg, var(--charcoal), var(--dark-gray));
      border: 1px solid rgba(212, 175, 55, 0.15);
      border-radius: 16px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .project-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--premium-gold), transparent);
    }
    
    .project-card:hover {
      transform: translateY(-3px);
      border-color: rgba(212, 175, 55, 0.3);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .status-badge {
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .status-new { 
      border-color: var(--electric-blue); 
      color: var(--electric-blue);
      background: rgba(0, 102, 204, 0.1);
    }
    .status-progress { 
      border-color: var(--premium-gold); 
      color: var(--premium-gold);
      background: rgba(212, 175, 55, 0.1);
    }
    .status-completed { 
      border-color: var(--neon-green); 
      color: var(--neon-green);
      background: rgba(0, 255, 136, 0.1);
    }
    .status-review { 
      border-color: #FF6B6B; 
      color: #FF6B6B;
      background: rgba(255, 107, 107, 0.1);
    }
    
    .btn-premium {
      background: linear-gradient(135deg, var(--premium-gold), #B8860B);
      color: var(--rich-black);
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-premium:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
      color: var(--rich-black);
    }
    
    .btn-demo {
      background: linear-gradient(135deg, var(--neon-green), #00CC66);
      color: var(--rich-black);
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-demo:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
      color: var(--rich-black);
    }
    
    .project-details {
      max-height: 100px;
      overflow: hidden;
      position: relative;
      transition: max-height 0.3s ease;
    }
    
    .project-details.expanded {
      max-height: 500px;
    }
    
    .read-more {
      background: linear-gradient(transparent, var(--charcoal));
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 40px 0 15px 0;
      text-align: center;
      transition: opacity 0.3s ease;
    }
    
    .read-more.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .text-gold {
      color: var(--premium-gold);
    }
    
    .text-electric {
      color: var(--electric-blue);
    }
    
    .text-neon {
      color: var(--neon-green);
    }
    
    .nav-pills-premium .nav-link {
      border-radius: 10px;
      margin: 0 4px;
      color: var(--pure-white);
      font-weight: 500;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .nav-pills-premium .nav-link.active {
      background: linear-gradient(135deg, var(--premium-gold), var(--electric-blue));
      color: var(--rich-black);
      border-color: transparent;
      transform: scale(1.05);
    }
    
    .cache-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--electric-blue);
      color: white;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 2;
    }
    
    .navbar-premium {
      background: rgba(10, 10, 10, 0.95) !important;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    .skeleton-loader {
      background: linear-gradient(90deg, #2A2A2A 25%, #3A3A3A 50%, #2A2A2A 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .glow-text {
      text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
    }
    
    /* Tawk.to Custom Position */
    .tawk-to-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
  </style>
</head>

<body>
  <!-- Premium Header -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-premium fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold fs-3 glow-text" href="index.html" style="color: var(--premium-gold);">IXIERA</a>
      
      <div class="d-flex align-items-center">
        <a href="index.html" class="btn btn-outline-light btn-sm me-3" style="border-color: var(--premium-gold); color: var(--premium-gold);">
          <i class="bi bi-house me-1"></i>Home
        </a>
        <span class="text-light me-3" id="user-email"></span>
        <button class="btn btn-outline-danger btn-sm" id="logout-btn">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container py-4" style="padding-top: 80px;">
    
    <!-- Loading -->
    <div id="loading-section">
      <div class="text-center py-5">
        <div class="spinner-border" style="color: var(--premium-gold); width: 3rem; height: 3rem;"></div>
        <p class="text-light mt-3">Memuat dashboard premium...</p>
      </div>
      
      <!-- Skeleton Loader -->
      <div id="skeleton-loader">
        <div class="row g-4 mb-5">
          <div class="col-md-3">
            <div class="premium-card stat-card">
              <div class="skeleton-loader" style="height: 40px; width: 40px; margin: 0 auto 15px;"></div>
              <div class="skeleton-loader" style="height: 30px; width: 60px; margin: 0 auto 8px;"></div>
              <div class="skeleton-loader" style="height: 16px; width: 80px; margin: 0 auto;"></div>
            </div>
          </div>
          <!-- Repeat for other stats -->
        </div>
      </div>
    </div>

    <!-- Access Denied -->
    <div id="access-denied-section" class="text-center py-5" style="display: none;">
      <div class="premium-card p-5 mx-auto" style="max-width: 400px;">
        <i class="bi bi-shield-lock display-1 text-gold"></i>
        <h3 class="mt-3 text-gold">Akses Premium</h3>
        <p class="text-light mb-4">Silakan login untuk mengakses dashboard</p>
        <a href="login.html" class="btn btn-premium">Login Sekarang</a>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard-content" style="display: none;">
      <!-- Header -->
      <div class="row align-items-center mb-5">
        <div class="col-md-8">
          <h1 class="fw-bold text-gold mb-2 glow-text">Dashboard Klien</h1>
          <p class="text-electric mb-1" id="welcome-message">Experience premium project monitoring</p>
          <small class="text-light opacity-75" id="cache-indicator"></small>
        </div>
        <div class="col-md-4 text-md-end">
          <a href="contact.html" class="btn btn-premium">
            <i class="bi bi-plus-circle me-2"></i>Project Baru
          </a>
        </div>
      </div>

      <!-- Stats -->
      <div class="row g-4 mb-5">
        <div class="col-md-3">
          <div class="premium-card stat-card">
            <i class="bi bi-briefcase"></i>
            <h3 class="fw-bold text-white mb-2" id="total-inquiries">0</h3>
            <p class="text-electric mb-0">Total Project</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="premium-card stat-card">
            <i class="bi bi-lightning-charge"></i>
            <h3 class="fw-bold text-white mb-2" id="in-progress">0</h3>
            <p class="text-gold mb-0">Dalam Proses</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="premium-card stat-card">
            <i class="bi bi-check2-all"></i>
            <h3 class="fw-bold text-white mb-2" id="completed">0</h3>
            <p class="text-neon mb-0">Selesai</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="premium-card stat-card">
            <i class="bi bi-star"></i>
            <h3 class="fw-bold text-white mb-2" id="awaiting-review">0</h3>
            <p class="text-electric mb-0">Menunggu Review</p>
          </div>
        </div>
      </div>

      <!-- Projects Section -->
      <div class="premium-card p-4 position-relative">
        <span class="cache-badge" id="cache-badge" style="display: none;">💾 Cache</span>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="text-gold mb-0">Project Portfolio</h4>
          <div class="nav nav-pills nav-pills-premium" id="filterTabs">
            <button class="nav-link active" data-filter="all">Semua</button>
            <button class="nav-link" data-filter="new">Baru</button>
            <button class="nav-link" data-filter="in_progress">Proses</button>
            <button class="nav-link" data-filter="completed">Selesai</button>
          </div>
        </div>

        <div id="projects-container">
          <!-- Projects will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Tawk.to Widget Container -->
  <div class="tawk-to-container">
    <!-- Tawk.to will inject here -->
  </div>

  <!-- Vendor JS -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  
  <!-- Tawk.to Script -->
  <script>
    // Tawk.to Configuration
    var Tawk_API = Tawk_API || {}, Tawk_LoadStart = new Date();
    (function(){
      var s1 = document.createElement("script"), s0 = document.getElementsByTagName("script")[0];
      s1.async = true;
      s1.src = 'https://embed.tawk.to/68e35e3ec72178194fdad4a8/default';
      s1.charset = 'UTF-8';
      s1.setAttribute('crossorigin', '*');
      s0.parentNode.insertBefore(s1, s0);
      
      // Custom Tawk.to styling
      Tawk_API = Tawk_API || {};
      Tawk_API.onLoad = function(){
        // Customize Tawk.to appearance to match premium theme
        if (typeof Tawk_API !== 'undefined') {
          Tawk_API.setAttributes({
            'name': 'Ixiera Client',
            'email': document.getElementById('user-email')?.textContent || 'Client',
            'hash': 'ixiera-dashboard'
          }, function(error){});
        }
      };
    })();
  </script>
  
  <!-- Dashboard JS -->
  <script type="module">
    import { getSupabase } from './assets/js/supabase-client.js';

    class ClientDashboard {
        constructor() {
            this.supabase = getSupabase();
            this.currentUser = null;
            this.projects = [];
            this.cacheKey = null;
            this.cacheDuration = 5 * 60 * 1000; // 5 minutes cache
            this.init();
        }

        async init() {
            const isAuthenticated = await this.checkAuthentication();
            if (isAuthenticated) {
                this.setupCache();
                await this.loadUserProjects();
                this.setupEventListeners();
                this.setupTawkTo();
            } else {
                this.showAccessDenied();
            }
        }

        setupTawkTo() {
            // Tawk.to will be initialized by the script above
            console.log('🎯 Tawk.to ready for client support');
        }

        setupCache() {
            this.cacheKey = `ixiera_projects_${this.currentUser.email}`;
        }

        getCachedData() {
            if (!this.cacheKey) return null;
            
            const cached = localStorage.getItem(this.cacheKey);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            const now = Date.now();
            
            if (now - timestamp < this.cacheDuration) {
                return data;
            } else {
                localStorage.removeItem(this.cacheKey);
                return null;
            }
        }

        setCachedData(data) {
            if (!this.cacheKey) return;
            
            const cacheData = {
                data: data,
                timestamp: Date.now()
            };
            localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
        }

        async checkAuthentication() {
            try {
                const { data: { session }, error } = await this.supabase.auth.getSession();
                if (error || !session) return false;

                this.currentUser = session.user;
                document.getElementById('user-email').textContent = this.currentUser.email;
                return true;
            } catch (error) {
                console.error('Auth error:', error);
                return false;
            }
        }

        async loadUserProjects(forceRefresh = false) {
            document.getElementById('skeleton-loader').style.display = 'block';
            
            try {
                let projects = null;
                let fromCache = false;

                if (!forceRefresh) {
                    projects = this.getCachedData();
                    if (projects) {
                        fromCache = true;
                        console.log('📦 Loading from cache');
                    }
                }

                if (!projects) {
                    console.log('🌐 Fetching from API');
                    const { data, error } = await this.supabase
                        .from('project_inquiries')
                        .select('*')
                        .eq('client_email', this.currentUser.email)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    projects = data || [];
                    this.setCachedData(projects);
                }

                this.projects = projects;
                
                if (this.projects.length > 0) {
                    this.showDashboard();
                    this.displayProjects();
                    this.updateStats();
                    this.showCacheIndicator(fromCache);
                } else {
                    this.showNoProjects();
                }
                
            } catch (error) {
                console.error('Error loading projects:', error);
                this.showError('Gagal memuat project');
            } finally {
                document.getElementById('skeleton-loader').style.display = 'none';
            }
        }

        showCacheIndicator(fromCache) {
            const indicator = document.getElementById('cache-indicator');
            const badge = document.getElementById('cache-badge');
            
            if (fromCache) {
                indicator.innerHTML = '<i class="bi bi-database me-1"></i>Data cached • ';
                badge.textContent = '💾 Cache';
                badge.style.display = 'block';
                badge.style.background = 'var(--electric-blue)';
            } else {
                indicator.innerHTML = '<i class="bi bi-wifi me-1"></i>Data live • ';
                badge.textContent = '🔄 Live';
                badge.style.display = 'block';
                badge.style.background = 'var(--neon-green)';
            }
            
            indicator.innerHTML += new Date().toLocaleTimeString('id-ID');
        }

        displayProjects() {
            const container = document.getElementById('projects-container');
            
            if (this.projects.length === 0) {
                container.innerHTML = this.getEmptyStateHTML();
                return;
            }

            container.innerHTML = this.projects.map(project => `
                <div class="project-card project-item" data-status="${project.status || 'new'}">
                    <div class="card-body p-4">
                        <div class="row align-items-start">
                            <div class="col-lg-8">
                                <div class="d-flex align-items-start justify-content-between mb-3">
                                    <div>
                                        <h5 class="fw-bold text-white mb-2">${this.escapeHtml(project.service_type)}</h5>
                                        <span class="status-badge status-${project.status || 'new'}">
                                            ${this.getStatusText(project.status)}
                                        </span>
                                    </div>
                                    <small class="text-electric">#${project.id}</small>
                                </div>
                                
                                <div class="project-details mb-3">
                                    <p class="text-light mb-0" style="white-space: pre-line; opacity: 0.9;">${this.escapeHtml(project.project_requirements)}</p>
                                    <div class="read-more">
                                        <button class="btn btn-link btn-sm p-0 text-premium read-more-btn" style="color: var(--premium-gold);">
                                            <i class="bi bi-chevron-down me-1"></i>Baca selengkapnya
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="d-flex flex-wrap gap-3 text-light" style="opacity: 0.7; font-size: 0.85rem;">
                                    <div>
                                        <i class="bi bi-calendar me-1"></i>
                                        ${new Date(project.created_at).toLocaleDateString('id-ID')}
                                    </div>
                                    <div>
                                        <i class="bi bi-person me-1"></i>
                                        ${this.escapeHtml(project.client_name)}
                                    </div>
                                    ${project.budget && project.budget !== 'Tidak ditentukan' ? `
                                        <div>
                                            <i class="bi bi-currency-dollar me-1"></i>
                                            ${project.budget}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                                <div class="d-flex flex-column gap-2">
                                    ${project.project_demo_url ? `
                                        <a href="${project.project_demo_url}" target="_blank" 
                                           class="btn btn-demo">
                                            <i class="bi bi-eye me-2"></i>View Demo
                                        </a>
                                    ` : `
                                        <button class="btn btn-outline-secondary" disabled style="border-color: var(--dark-gray); color: var(--dark-gray);">
                                            <i class="bi bi-eye me-2"></i>Demo Coming
                                        </button>
                                    `}
                                    <small class="text-electric">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        Updated: ${new Date(project.created_at).toLocaleDateString('id-ID')}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            this.setupProjectInteractions();
            this.setupProjectFilters();
        }

        setupProjectInteractions() {
            document.querySelectorAll('.read-more-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const details = e.target.closest('.project-details');
                    const readMore = details.querySelector('.read-more');
                    
                    details.classList.toggle('expanded');
                    readMore.classList.toggle('hidden');
                    
                    const icon = e.target.querySelector('.bi');
                    if (details.classList.contains('expanded')) {
                        e.target.innerHTML = '<i class="bi bi-chevron-up me-1"></i>Sembunyikan';
                    } else {
                        e.target.innerHTML = '<i class="bi bi-chevron-down me-1"></i>Baca selengkapnya';
                    }
                });
            });
        }

        setupProjectFilters() {
            const filterButtons = document.querySelectorAll('[data-filter]');
            const projectItems = document.querySelectorAll('.project-item');

            filterButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filter = e.target.dataset.filter;
                    filterButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    projectItems.forEach(item => {
                        item.style.display = (filter === 'all' || item.dataset.status === filter) ? 'block' : 'none';
                    });
                });
            });
        }

        updateStats() {
            const stats = {
                total: this.projects.length,
                inProgress: this.projects.filter(p => p.status === 'in_progress').length,
                completed: this.projects.filter(p => p.status === 'completed').length,
                awaitingReview: this.projects.filter(p => p.status === 'review').length
            };

            document.getElementById('total-inquiries').textContent = stats.total;
            document.getElementById('in-progress').textContent = stats.inProgress;
            document.getElementById('completed').textContent = stats.completed;
            document.getElementById('awaiting-review').textContent = stats.awaitingReview;
        }

        getStatusText(status) {
            const statusMap = {
                'new': '🆕 Baru',
                'review': '🔍 Review', 
                'in_progress': '⚡ Proses',
                'completed': '✅ Selesai'
            };
            return statusMap[status] || '🆕 Baru';
        }

        getEmptyStateHTML() {
            return `
                <div class="text-center py-5">
                    <i class="bi bi-stars display-1 text-gold"></i>
                    <h4 class="mt-3 text-gold">Portfolio Kosong</h4>
                    <p class="text-light mb-4">Mulai perjalanan digital premium Anda</p>
                    <a href="contact.html" class="btn btn-premium">Launch Project</a>
                </div>
            `;
        }

        showDashboard() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('access-denied-section').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
        }

        showAccessDenied() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('access-denied-section').style.display = 'block';
        }

        showNoProjects() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('projects-container').innerHTML = this.getEmptyStateHTML();
        }

        showError(message) {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('projects-container').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }

        escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await this.supabase.auth.signOut();
                window.location.href = 'login.html';
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new ClientDashboard();
    });
  </script>
</body>
</html>